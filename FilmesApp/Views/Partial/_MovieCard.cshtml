@model object
@using FilmesApp.Models
@using FilmesApp.Models.TmdbDtos

@*
  Partial seguro para exibir um card de filme.
  Aceita: Filme (local), MovieItemDto (TMDb search results), ou outros.
*@

@{
    string title = "Sem título";
    string poster = "/images/no-poster.png";
    string overview = string.Empty;
    int tmdbId = 0;
    int localId = 0;

    // Caso 1: entidade local Filme
    if (Model is Filme f)
    {
        title = f.Titulo ?? "Sem título";
        poster = string.IsNullOrWhiteSpace(f.PosterPath) ? "/images/no-poster.png" : f.PosterPath;
        overview = f.Sinopse ?? string.Empty;
        localId = f.Id;
        tmdbId = f.TmdbId;
    }
    // Caso 2: DTO do TMDb (Search result)
    else if (Model is MovieItemDto m)
    {
        title = m.Title ?? "Sem título";
        poster = string.IsNullOrWhiteSpace(m.PosterPath) ? "/images/no-poster.png" : m.PosterPath;
        overview = m.Overview ?? string.Empty;
        tmdbId = m.Id;
        // localId permanece 0 (não importado ainda)
    }
    // Fallback genérico: tenta via reflection propriedades comuns (Title/Titulo, poster_path/PosterPath, overview/Overview)
    else if (Model != null)
    {
        var t = Model.GetType();
        var propTitle = t.GetProperty("Titulo") ?? t.GetProperty("Title");
        var propPoster = t.GetProperty("PosterPath") ?? t.GetProperty("poster_path") ?? t.GetProperty("Poster_Path");
        var propOverview = t.GetProperty("Sinopse") ?? t.GetProperty("Overview") ?? t.GetProperty("overview");
        var propTmdbId = t.GetProperty("Id") ?? t.GetProperty("id") ?? t.GetProperty("TmdbId");

        try
        {
            var valTitle = propTitle?.GetValue(Model);
            if (valTitle != null) title = valTitle.ToString() ?? title;

            var valPoster = propPoster?.GetValue(Model);
            if (valPoster != null && !string.IsNullOrWhiteSpace(valPoster.ToString()))
            {
                poster = valPoster.ToString();
            }

            var valOverview = propOverview?.GetValue(Model);
            if (valOverview != null) overview = valOverview.ToString() ?? string.Empty;

            var valTmdb = propTmdbId?.GetValue(Model);
            if (valTmdb != null && int.TryParse(valTmdb.ToString(), out var parsedId))
            {
                tmdbId = parsedId;
            }
        }
        catch
        {
            // se reflection falhar, usamos defaults seguros
        }
    }
}

<div class="netflix-movie-card">

    <div class="movie-poster-wrapper">
        <img src="@poster"
             alt="@title"
             onerror="this.src='/images/no-poster.png';"/>

        <div class="movie-overlay">

            @if (localId != 0)
            {
                <a class="btn-play" href="@Url.Action("Details", "Filme", new { id = localId })">▶</a>
            }
            else if (tmdbId != 0)
            {
                <a class="btn-play" href="@Url.Action("Details", "Filme", new { tmdbId = tmdbId })">▶</a>
            }

            <div class="overlay-info">
                <h3 class="movie-title">@title</h3>
            </div>

        </div>
    </div>

</div>

<style>
    .netflix-movie-card {
        background: transparent;
        border-radius: 18px;
        overflow: hidden;
        transition: .3s ease;
        cursor: pointer;
        position: relative;
    }

    .netflix-movie-card:hover {
        transform: scale(1.12);
        z-index: 50;
    }

    .movie-poster-wrapper {
        position: relative;
        border-radius: 18px;
        overflow: hidden;
        box-shadow: 0 10px 25px rgba(0,0,0,.6);
    }

    .movie-poster-wrapper img {
        width: 100%;
        height: 270px;
        object-fit: cover;
        transition: .3s;
    }

    .netflix-movie-card:hover img {
        filter: brightness(.55);
    }
    
    .movie-overlay {
        position: absolute;
        inset: 0;
        background: linear-gradient(to top, rgba(0,0,0,.9), rgba(0,0,0,.1));
        opacity: 0;
        transition: .25s;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: center;
        padding: 14px;
    }

    .netflix-movie-card:hover .movie-overlay {
        opacity: 1;
    }
    
    .btn-play {
        margin-top: auto;
        margin-bottom: auto;
        width: 54px;
        height: 54px;
        border-radius: 50%;
        background: #fff;
        color: #000;
        font-size: 20px;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        transition: .2s ease;
    }

    .btn-play:hover {
        background: #e50914;
        color: #fff;
        transform: scale(1.1);
    }
    
    .overlay-info {
        width: 100%;
        text-align: left;
    }

    .movie-title {
        font-size: 14px;
        font-weight: 600;
        color: #fff;
        margin: 0;
        opacity: .95;
    }

</style>


